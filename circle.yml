machine:
  node:
    version: 4.3.0

general:
  artifacts:
    - "screenshots"

dependencies:
  pre:
    # Setup gradle.properties with e2eflowtesting OAUTH token
    - cp WordPress/gradle.properties-example WordPress/gradle.properties
    - sed -i '' "s/^wp.oauth.app_id.*$/wp.oauth.app_id = $OAUTH_APP_ID/" WordPress/gradle.properties
    - sed -i '' "s/^wp.oauth.app_secret.*$/wp.oauth.app_secret = $OAUTH_TOKEN/" WordPress/gradle.properties
    # Install custom Slack/XUnit/Spec reporter
    - npm pack WordPress/src/androidTest/e2eTests/lib/reporter
    - npm install ./spec-xunit-slack-reporter-0.0.1.tgz

test:
  pre:
    - ./gradlew -PdisablePreDex assembleVanillaRelease
    - emulator -avd circleci-android22 -no-audio -no-window:
        background: true
        parallel: true
    - circle-android wait-for-boot
    - ./node_modules/.bin/appium
        background: true
        parallel: true
  override:
    - >
      export TESTARGS="-R -p -l"

      if [ "$RUN_SPECIFIED" == "true" ]; then
        TESTARGS=$RUN_ARGS
      elif [ "$CIRCLE_BRANCH" == "master" ]; then
        TESTARGS="-R -p -l"
      fi

      npm test

experimental:
  notify:
    branches:
      ignore:
        - /^try.*/
